// スプレッドシートのIDをここに設定
const SPREADSHEET_ID = '1bGWuRqLbUfb1yO1yxDWXqEGob-f1aL74907tJ3nkZeg';
// シート名を指定
const SHEET_NAME = 'Holidays'; // シート名はご自身の環境に合わせて変更してください

/**
 * Webアプリにアクセスした際にHTMLを返す
 */
function doGet(e) {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('得意先お休み管理カレンダー')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

/**
 * 得意先名に基づいて一貫した色を生成する
 * @param {string} clientName - 得意先名
 * @returns {string} HSL形式のカラーコード
 */
function getClientColor(clientName) {
  if (!clientName) return '#6c757d'; // 未設定の場合はグレー

  let hash = 0;
  for (let i = 0; i < clientName.length; i++) {
    hash = clientName.charCodeAt(i) + ((hash << 5) - hash);
    hash = hash & hash; // 32bit整数に変換
  }
 
  // HSL色空間を使うことで、見やすい色を生成
  const hue = Math.abs(hash % 360); // 色相 (0-359)
  const saturation = 75; // 彩度 (高めに設定)
  const lightness = 50;  // 明度 (中間)
 
  return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
}

/**
 * スプレッドシートから休日の予定を取得して返す
 * @returns {Array} 休日のイベントオブジェクトの配列
 */
function getHolidays() {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    if (sheet.getLastRow() < 2) return []; // ヘッダーのみの場合は空配列を返す

    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 6).getValues();
   
    const holidays = data.map(row => {
      if (row[0]) { // IDがあれば処理
        return {
          id: row[0],
          title: row[1],
          start: row[2] ? new Date(row[2]).toISOString().split('T')[0] : null,
          end: row[3] ? new Date(row[3]).toISOString().split('T')[0] : null,
          extendedProps: {
            clientName: row[4]
          },
          backgroundColor: row[5] || getClientColor(row[4]), // 保存された色、なければ生成
          borderColor: row[5] || getClientColor(row[4])
        };
      }
    }).filter(item => item);
   
    return holidays;
  } catch (e) {
    console.error('休日の取得に失敗しました:', e);
    return [];
  }
}

/**
 * 新しい休日をスプレッドシートに追加する
 * @param {Object} event - カレンダーで作成されたイベント情報
 */
function addHoliday(event) {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    const newId = Utilities.getUuid();
    const clientName = event.extendedProps ? event.extendedProps.clientName : '';
    const color = getClientColor(clientName);
    const endDate = event.end ? new Date(event.end) : new Date(new Date(event.start).getTime() + 24 * 60 * 60 * 1000);

    sheet.appendRow([
      newId,
      event.title,
      new Date(event.start),
      endDate,
      clientName,
      color // 生成した色を保存
    ]);
    return { status: 'success', id: newId };
  } catch (e) {
    console.error('休日の追加に失敗しました:', e);
    return { status: 'error', message: e.toString() };
  }
}

/**
 * 既存の休日の日付や内容を更新する
 * @param {Object} event - 更新されたイベント情報
 */
function updateHoliday(event) {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues();
   
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == event.id) {
        const rowNum = i + 2;
        const clientName = event.extendedProps ? event.extendedProps.clientName : '';
        const newColor = getClientColor(clientName);
        const endDate = event.end ? new Date(event.end) : new Date(new Date(event.start).getTime() + 24 * 60 * 60 * 1000);
       
        // 該当行のデータをまとめて更新
        sheet.getRange(rowNum, 2, 1, 5).setValues([[
          event.title,
          new Date(event.start),
          endDate,
          clientName,
          newColor
        ]]);
        return { status: 'success' };
      }
    }
    return { status: 'error', message: 'Event not found' };
  } catch (e) {
    console.error('休日の更新に失敗しました:', e);
    return { status: 'error', message: e.toString() };
  }
}

/**
 * 休日を削除する
 * @param {string} eventId - 削除するイベントのID
 */
function deleteHoliday(eventId) {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues();

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == eventId) {
        sheet.deleteRow(i + 2);
        return { status: 'success' };
      }
    }
    return { status: 'error', message: 'Event not found' };
  } catch (e) {
    console.error('休日の削除に失敗しました:', e);
    return { status: 'error', message: e.toString() };
  }
}


/**
 * 1週間以内に始まる休みをメールで通知する
 * この関数をトリガーで定期実行する
 */
function checkAndSendNotifications() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const oneWeekLater = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

  const holidays = getHolidays();
  const upcomingHolidays = holidays.filter(holiday => {
    const startDate = new Date(holiday.start);
    return startDate >= today && startDate < oneWeekLater;
  });

  if (upcomingHolidays.length > 0) {
    let mailBody = '直近1週間の得意先お休み情報です。\n\n';
   
    upcomingHolidays.sort((a, b) => new Date(a.start) - new Date(b.start));
   
    upcomingHolidays.forEach(holiday => {
      const startDate = new Date(holiday.start);
      const dateString = `${startDate.getMonth() + 1}/${startDate.getDate()}`;
      mailBody += `・${dateString} (${holiday.extendedProps.clientName || '未設定'}) - ${holiday.title}\n`;
    });

    const recipient = Session.getActiveUser().getEmail();
    const subject = '【通知】直近1週間の得意先お休み情報';
   
    MailApp.sendEmail(recipient, subject, mailBody);
  }
}
